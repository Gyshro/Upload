<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Carta de F√£ - Jogo do Violino</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Courier New',monospace;background:linear-gradient(135deg,#f5f5dc,#e6e6fa);height:100vh;display:flex;align-items:center;justify-content:center;touch-action:manipulation;user-select:none}
  .letter-container{width:90vw;max-width:700px;height:85vh;background:#f9f9f9;border:3px solid #ddd;border-radius:15px;position:relative;box-shadow:0 10px 30px rgba(0,0,0,0.25);transform:rotate(-2deg);animation:paperFloat 3s ease-in-out infinite;overflow:hidden}
  @keyframes paperFloat{0%,100%{transform:rotate(-2deg) translateY(0)}50%{transform:rotate(-1deg) translateY(-6px)}}
  .paper-texture{position:absolute;inset:0;background:
    radial-gradient(circle at 20% 30%, rgba(200,200,200,0.08) 1px, transparent 1px),
    radial-gradient(circle at 80% 70%, rgba(200,200,200,0.06) 1px, transparent 1px),
    radial-gradient(circle at 40% 80%, rgba(200,200,200,0.05) 1px, transparent 1px);border-radius:15px;pointer-events:none}
  .kiss-mark{position:absolute;top:12%;right:8%;font-size:clamp(26px,5.5vw,48px);color:#ff69b4;transform:rotate(14deg);filter:drop-shadow(2px 2px 4px rgba(0,0,0,0.18))}
  .main-text{position:absolute;top:18%;left:12%;right:12%;font-family:'Brush Script MT',cursive,'Courier New',monospace;font-size:clamp(18px,4vw,28px);color:#2c3e50;line-height:1.6;text-align:center;transform:rotate(1deg)}
  .rose{position:absolute;bottom:16%;right:18%;font-size:clamp(24px,5vw,40px);transform:rotate(-10deg);filter:drop-shadow(2px 2px 4px rgba(0,0,0,0.18))}
  .heart{position:absolute;bottom:20%;left:18%;font-size:clamp(18px,4vw,34px);color:#e74c3c;animation:heartbeat 2s ease-in-out infinite}
  @keyframes heartbeat{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
  .thought-bubble{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.96);border:2px solid #333;border-radius:20px;padding:14px 22px;font-size:clamp(14px,3vw,18px);color:#333;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,0.12);z-index:10;max-width:80%}
  .read-button{position:absolute;bottom:10%;left:50%;transform:translateX(-50%);background:linear-gradient(45deg,#ff6b6b,#ee5a24);color:#fff;border:none;padding:14px 28px;font-size:clamp(15px,3.2vw,20px);font-weight:700;border-radius:24px;cursor:pointer;box-shadow:0 5px 15px rgba(0,0,0,0.2);z-index:10;display:none}
  .read-button:active{transform:translateX(-50%) translateY(1px)}
  .skip-button{position:absolute;bottom:10%;right:6%;background:rgba(0,0,0,0.6);color:#fff;border:none;padding:8px 12px;border-radius:12px;cursor:pointer;z-index:11;display:none}
  .typing-text{display:none;position:absolute;top:12%;left:8%;right:8%;bottom:12%;overflow:auto;padding:18px;font-family:'Brush Script MT',cursive,'Courier New',monospace;font-size:clamp(16px,3.2vw,20px);color:#2c3e50;line-height:1.6;background:transparent;border-radius:8px}
  .cursor{display:inline-block;background:#2c3e50;width:2px;animation:blink 1s infinite;margin-left:2px;vertical-align:text-bottom}
  @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}
  .back-button{position:absolute;top:14px;left:14px;background:rgba(0,0,0,0.7);color:#fff;border:none;padding:10px 14px;border-radius:18px;cursor:pointer;z-index:15}
  .crumpled-effect{position:absolute;inset:0;background:
    radial-gradient(ellipse at 25% 25%, rgba(0,0,0,0.03) 0%, transparent 50%),
    radial-gradient(ellipse at 75% 75%, rgba(0,0,0,0.03) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 10%, rgba(0,0,0,0.02) 0%, transparent 40%);pointer-events:none;border-radius:15px}
  @media (max-width:768px){.main-text{left:10%;right:10%}.thought-bubble{max-width:90%;padding:12px 18px}.typing-text{top:10%;left:6%;right:6%;bottom:14%}}
</style>
</head>
<body>
  <button class="back-button" onclick="goBack()">‚Üê Voltar</button>

  <div class="letter-container" id="letterContainer">
    <div class="paper-texture"></div>
    <div class="crumpled-effect"></div>

    <div class="kiss-mark">üíã</div>

    <div class="main-text" id="mainText">Voc√™ √© uma inspira√ß√£o!! Sou seu f√£</div>

    <div class="rose">üåπ</div>
    <div class="heart">‚ù§Ô∏è</div>

    <div class="thought-bubble" id="thoughtBubble">U√©, um bilhete? Isso aqui n√£o √© um papel de catarro n√£o, n√©?</div>

    <button class="read-button" id="readButton">Ler</button>
    <button class="skip-button" id="skipButton">Pular</button>

    <div class="typing-text" id="typingText" aria-live="polite"></div>
  </div>

<script>
/*
  letter.html ‚Äî vers√£o robusta
  - tenta carregar romantic_music.mp3 -> fallback .wav -> sem m√∫sica
  - bot√£o "Ler" dispara digita√ß√£o sincronizada com a dura√ß√£o da m√∫sica (quando dispon√≠vel)
  - bot√£o "Pular" finaliza a digita√ß√£o imediatamente
  - evita tela branca mesmo se √°udio falhar
*/

class LetterReader {
  constructor(opts = {}) {
    this.musicCandidates = opts.musicCandidates || ['romantic_music.mp3','romantic_music.wav','romantic_music.ogg'];
    this.defaultMusicDuration = opts.defaultMusicDuration || 60; // segundos fallback
    this.letterText = opts.letterText || `Querida violinista,

Desde o primeiro momento em que ouvi voc√™ tocar, meu cora√ß√£o se encheu de uma melodia que nunca havia sentido antes. Suas notas dan√ßam no ar como borboletas douradas, tocando minha alma de uma forma que as palavras n√£o conseguem expressar.

Voc√™ n√£o √© apenas uma musicista, voc√™ √© uma artista que transforma sons em emo√ß√µes, que faz o imposs√≠vel parecer simples e natural. Cada acorde que voc√™ toca ressoa dentro de mim como um eco de algo divino.

Sua paix√£o pela m√∫sica √© contagiante, sua dedica√ß√£o √© inspiradora, e seu talento √© simplesmente extraordin√°rio. Voc√™ me ensinou que a m√∫sica n√£o √© apenas som, mas sim a linguagem universal do cora√ß√£o.

Obrigado por existir, por compartilhar seu dom conosco, e por fazer deste mundo um lugar mais belo e harmonioso. Voc√™ √© verdadeiramente especial, e espero que continue tocando e encantando cora√ß√µes por toda a vida.

Com admira√ß√£o e carinho infinitos,
Seu f√£ mais dedicado üíï

P.S.: Que sua m√∫sica continue sendo a trilha sonora dos sonhos de muitas pessoas, assim como √© da minha.`;

    // elementos
    this.readButton = document.getElementById('readButton');
    this.skipButton = document.getElementById('skipButton');
    this.thoughtBubble = document.getElementById('thoughtBubble');
    this.mainText = document.getElementById('mainText');
    this.typingArea = document.getElementById('typingText');

    // state
    this.musicAudio = null;
    this.musicDuration = null;
    this.typingInterval = null;
    this.isTyping = false;
    this.isMusicLoaded = false;
    this.index = 0;

    this.setup();
  }

  setup() {
    // tentar carregar primeiro candidate existente
    this.tryLoadMusicCandidates().finally(() => {
      // mostrar bot√£o "Ler" ap√≥s pequena espera (est√©tica)
      setTimeout(() => {
        this.thoughtBubble.style.display = 'none';
        this.readButton.style.display = 'block';
        this.skipButton.style.display = 'none';
      }, 1000);
    });

    // ligar eventos
    this.readButton.addEventListener('click', (e) => {
      e.preventDefault();
      this.startReading();
    });

    this.skipButton.addEventListener('click', (e) => {
      e.preventDefault();
      this.finishTypingImmediately();
    });

    // permitir clique na typingArea pra pular tamb√©m
    this.typingArea.addEventListener('click', () => {
      if (this.isTyping) this.finishTypingImmediately();
    });
  }

  async tryLoadMusicCandidates() {
    for (const candidate of this.musicCandidates) {
      try {
        const audio = new Audio();
        audio.src = candidate;
        // start loading metadata
        await new Promise((resolve, reject) => {
          const onLoaded = () => { resolve(true); };
          const onError = () => { resolve(false); }; // resolve false para tentar pr√≥ximo
          // loadedmetadata normalmente indica duration known
          audio.addEventListener('loadedmetadata', onLoaded, { once: true });
          audio.addEventListener('error', onError, { once: true });
          // force load
          try { audio.load(); } catch(e) { /* ignore */ }
          // tamb√©m timeout fallback
          setTimeout(() => resolve(false), 1200);
        }).then((ok) => {
          if (ok && !isNaN(audio.duration) && audio.duration > 0) {
            this.musicAudio = audio;
            this.musicDuration = audio.duration;
            this.isMusicLoaded = true;
          }
        });
        if (this.isMusicLoaded) break;
      } catch (err) {
        // continue to next candidate
        console.warn('Erro carregando √°udio candidato', candidate, err);
      }
    }

    if (!this.isMusicLoaded) {
      // fallback: cria um audio vazio apenas para evitar c√≥digo quebrar
      try {
        this.musicAudio = new Audio();
      } catch(e) { this.musicAudio = null; }
      this.musicDuration = this.defaultMusicDuration;
    }
  }

  startReading() {
    if (this.isTyping) return; // evita clique duplo

    // UI
    this.readButton.style.display = 'none';
    this.thoughtBubble.style.display = 'none';
    this.mainText.style.display = 'none';
    this.typingArea.style.display = 'block';
    this.skipButton.style.display = 'block';
    this.typingArea.innerHTML = '';
    this.index = 0;

    // calcular velocidade com base na dura√ß√£o (se souber), caso contr√°rio fallback
    const duration = (this.isMusicLoaded && !isNaN(this.musicDuration) && this.musicDuration > 0) ? this.musicDuration : this.defaultMusicDuration;

    // ms por caractere (limitado)
    const totalChars = Math.max(1, this.letterText.length);
    let msPerChar = Math.round((duration * 1000) / totalChars);
    msPerChar = Math.max(6, Math.min(160, msPerChar)); // limites mais razo√°veis

    // tentar tocar a m√∫sica
    if (this.musicAudio && typeof this.musicAudio.play === 'function') {
      try {
        this.musicAudio.currentTime = 0;
        // tocar s√≥ ap√≥s intera√ß√£o (tem clique)
        const playPromise = this.musicAudio.play();
        if (playPromise && playPromise.catch) {
          playPromise.catch(e => console.warn('Reprodu√ß√£o bloqueada ou falhou:', e));
        }
      } catch (e) {
        console.warn('Erro ao iniciar √°udio:', e);
      }
    }

    // iniciar digita√ß√£o
    this.isTyping = true;
    this.typeText(msPerChar);
  }

  typeText(msPerChar) {
    const text = this.letterText;
    this.index = 0;

    this.typingInterval = setInterval(() => {
      if (this.index >= text.length) {
        clearInterval(this.typingInterval);
        this.isTyping = false;
        // remover cursor
        setTimeout(() => {
          const c = this.typingArea.querySelector('.cursor');
          if (c) c.remove();
        }, 800);
        // esconder skip
        this.skipButton.style.display = 'none';
        return;
      }

      const ch = text[this.index];
      if (ch === '\n') {
        this.typingArea.innerHTML += '<br>';
      } else {
        const safe = ch.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        this.typingArea.innerHTML += safe;
      }
      this.index++;

      // cursor management: keep only last cursor
      const cursors = this.typingArea.querySelectorAll('.cursor');
      cursors.forEach((el, i) => { if (i < cursors.length - 1) el.remove(); });
      this.typingArea.innerHTML += '<span class="cursor">|</span>';

      // autoscroll
      this.typingArea.scrollTop = this.typingArea.scrollHeight;

    }, msPerChar);
  }

  finishTypingImmediately() {
    if (!this.isTyping) return;
    // stop interval
    clearInterval(this.typingInterval);
    // write remaining text quickly
    const remaining = this.letterText.slice(this.index);
    const safe = remaining.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
    // remove trailing cursor(s)
    const cursors = this.typingArea.querySelectorAll('.cursor');
    cursors.forEach(c => c.remove());
    this.typingArea.innerHTML += safe;
    // remove cursor and finalize
    const finalCursor = this.typingArea.querySelector('.cursor');
    if (finalCursor) finalCursor.remove();
    this.isTyping = false;
    this.skipButton.style.display = 'none';
    // ensure music is playing or left as is (do not stop by default)
  }
}

function goBack(){ window.location.href = 'index.html'; }

// inicializa quando DOM pronto
document.addEventListener('DOMContentLoaded', () => {
  // instancia globalmente para debugging se quiser (n√£o necess√°rio)
  window.letterReaderInstance = new LetterReader();

  // exp√µe atalho global caso algum onclick ainda chame startReading()
  window.startReading = () => { if (window.letterReaderInstance) window.letterReaderInstance.startReading(); };
});
</script>
</body>
</html>
